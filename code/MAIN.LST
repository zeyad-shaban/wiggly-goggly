
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	..\main.asm
	Object File:	..\main.hex
	List File:	..\main.lst



 Line  I  Addr  Code            Source

    1:				; VARS
    2:		B      00A6	US_RIGHT EQU P2.6
    3:		B      00A7	US_LEFT EQU P2.7
    4:
    5:		B      00A0	LED_RED_L EQU P2.0
    6:		B      00A1	LED_YELLOW_L EQU P2.1
    7:		B      00A2	LED_GREEN EQU P2.2
    8:		B      00A3	LED_YELLOW_R EQU P2.3
    9:		B      00A4	LED_RED_R EQU P2.4
   10:
   11:
   12:		N      0000	ORG 0000h
   13:	  0000	02 00 11	LJMP START    ; Jump to start of program
   14:
   15:
   16:				; ------DELAY SUBROUTINES-----
   17:	  0003			DELAY1US:
   18:	  0003	7A 02		    MOV R2, #2       ; Outer count for roughly 2 µs
   19:	  0005			D1:
   20:	  0005	00		    NOP              ; 1 cycle
   21:	  0006	00		    NOP              ; 1 cycle
   22:	  0007	DA FC		    DJNZ R2, D1      ; 2 cycles when decrement ≠ 0, 1 cycle when zero
   23:	  0009	22		    RET
   24:
   25:	  000A			DELAY10US:
   26:	  000A	7A 0A		    MOV R2, #10
   27:	  000C			D10:
   28:	  000C	11 03		    ACALL DELAY1US
   29:	  000E	DA FC		    DJNZ R2, D10
   30:	  0010	22		    RET
   31:
   32:				;--- Main ---
   33:	  0011	75 89 00	START:      MOV TMOD, #00h   ; Clear timers
   34:	  0014	C2 8C		            CLR  TR0         ; ensure timer 0 stops
   35:	  0016	C2 8D		            CLR  TF0         ; clear overflow flag
   36:
   37:				            ; Initialize all LEDs to OFF
   38:	  0018	75 A0 00	            MOV  P2, #000h   ; Initialize all pins high
   39:
   40:	  001B			MAIN_LOOP:
   41:				    ; 1. Trigger
   42:	  001B	C2 A6		        CLR  US_RIGHT
   43:	  001D	11 03		        ACALL DELAY1US

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

   44:	  001F	D2 A6		        SETB US_RIGHT
   45:	  0021	11 0A		        ACALL DELAY10US
   46:	  0023	C2 A6		        CLR  US_RIGHT
   47:
   48:
   49:				    ; 2. Measure Echo
   50:	  0025	20 A6 02	WAIT_HIGH:  JB   US_RIGHT, OK_HIGH
   51:	  0028	80 FB		            SJMP WAIT_HIGH
   52:	  002A	75 89 01	OK_HIGH:    MOV  TMOD, #01h  ; Timer0 Mode1
   53:	  002D	C2 8C		            CLR  TR0
   54:	  002F	C2 8D		            CLR  TF0
   55:	  0031	75 8C 00	            MOV  TH0, #0     ; Reset timer high byte
   56:	  0034	75 8A 00	            MOV  TL0, #0     ; Reset timer low byte
   57:	  0037	D2 8C		            SETB TR0
   58:
   59:	  0039	30 A6 02	WAIT_LOW:   JNB  US_RIGHT, OK_LOW
   60:	  003C	80 FB		            SJMP WAIT_LOW
   61:	  003E	C2 8C		OK_LOW: CLR TR0
   62:
   63:				    ; 3. Compare Timer Value Against 1160 (20cm)
   64:	  0040	E5 8C		        MOV A, TH0
   65:	  0042	B4 04 07	        CJNE A, #04h, CHECK_HIGH
   66:	  0045	E5 8A		        MOV A, TL0
   67:	  0047	B4 88 07	        CJNE A, #88h, CHECK_LOW
   68:	  004A	80 10		        SJMP DIST_EQUAL
   69:
   70:	  004C	40 08		CHECK_HIGH: JC DIST_LESS
   71:	  004E	02 00 5A	        JMP DIST_MORE
   72:
   73:	  0051	40 03		CHECK_LOW: JC DIST_LESS
   74:	  0053	02 00 5A	        JMP DIST_MORE
   75:
   76:	  0056	D2 A4		DIST_LESS: SETB LED_RED_R
   77:	  0058	80 04		        SJMP NEXT
   78:
   79:	  005A	C2 A4		DIST_MORE: CLR LED_RED_R
   80:	  005C	C2 A4		DIST_EQUAL: CLR LED_RED_R
   81:
   82:				;========
   83:				; THIS NEXT IS JUST DUMMY FOR TESTING PURPOSE, IT SHOULD SET ALL PORT 2 TO ONES INFINITELY IF REACHE
				D,
   84:				; THIS DUMMY TEST SHOWS THAT WITH THE CURRENT IMPLEMENTAITON NEXT IS NEVER ACTUALLY REAACHED!!
   85:	  005E			NEXT:   ; Test section - infinite loop setting P2 to all 1's
   86:	  005E	75 A0 FF	        MOV P2, #0FFh    ; Set all P2 bits to 1
   87:	  0061			TEST_LOOP:
   88:	  0061	80 FE		        SJMP TEST_LOOP   ; Infinite loop
   89:				;========
   90:
   91:				;NEXT:   ; Add logic for other sensors/LEDs
   92:				;        ACALL DELAY10US
   93:				;        SJMP MAIN_LOOP
   94:				;
   95:				END




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3





                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6
ACC				  DATA	      E0
B				  DATA	      F0
CHECK_HIGH			  CODE	    004C	  70
CHECK_LOW			  CODE	    0051	  73
CY				  BIT	      D7
D1				  CODE	    0005	  19
D10				  CODE	    000C	  27
DELAY10US			  CODE	    000A	  25
DELAY1US			  CODE	    0003	  17
DIST_EQUAL			  CODE	    005C	  80
DIST_LESS			  CODE	    0056	  76
DIST_MORE			  CODE	    005A	  79
DPH				  DATA	      83
DPL				  DATA	      82
EA				  BIT	      AF
ES				  BIT	      AC
ET0				  BIT	      A9
ET1				  BIT	      AB
EX0				  BIT	      A8
EX1				  BIT	      AA
EXTI0				  CODE	    0003
EXTI1				  CODE	    0013
F0				  BIT	      D5
IE				  DATA	      A8
IE0				  BIT	      89
IE1				  BIT	      8B
INT0				  BIT	      B2
INT1				  BIT	      B3
IP				  DATA	      B8
IT0				  BIT	      88
IT1				  BIT	      8A
LED_GREEN			  NUMBER    00A2	   7
LED_RED_L			  NUMBER    00A0	   5
LED_RED_R			  NUMBER    00A4	   9
LED_YELLOW_L			  NUMBER    00A1	   6
LED_YELLOW_R			  NUMBER    00A3	   8
MAIN_LOOP			  CODE	    001B	  40
NEXT				  CODE	    005E	  85
OK_HIGH				  CODE	    002A	  52
OK_LOW				  CODE	    003E	  61
OV				  BIT	      D2
P				  BIT	      D0
P0				  DATA	      80
P1				  DATA	      90
P2				  DATA	      A0
P3				  DATA	      B0
PCON				  DATA	      87

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
PS				  BIT	      BC
PSW				  DATA	      D0
PT0				  BIT	      B9
PT1				  BIT	      BB
PX0				  BIT	      B8
PX1				  BIT	      BA
RB8				  BIT	      9A
RD				  BIT	      B7
REN				  BIT	      9C
RESET				  CODE	    0000
RI				  BIT	      98
RS0				  BIT	      D3
RS1				  BIT	      D4
RXD				  BIT	      B0
SBUF				  DATA	      99
SCON				  DATA	      98
SINT				  CODE	    0023
SM0				  BIT	      9F
SM1				  BIT	      9E
SM2				  BIT	      9D
SP				  DATA	      81
START				  CODE	    0011	  33
T0				  BIT	      B4
T1				  BIT	      B5
TB8				  BIT	      9B
TCON				  DATA	      88
TEST_LOOP			  CODE	    0061	  87
TF0				  BIT	      8D
TF1				  BIT	      8F
TH0				  DATA	      8C
TH1				  DATA	      8D
TI				  BIT	      99
TIMER0				  CODE	    000B
TIMER1				  CODE	    001B
TL0				  DATA	      8A
TL1				  DATA	      8B
TMOD				  DATA	      89
TR0				  BIT	      8C
TR1				  BIT	      8E
TXD				  BIT	      B1
US_LEFT				  NUMBER    00A7	   3
US_RIGHT			  NUMBER    00A6	   2
WAIT_HIGH			  CODE	    0025	  50
WAIT_LOW			  CODE	    0039	  59
WR				  BIT	      B6
