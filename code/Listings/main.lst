A51 MACRO ASSEMBLER  MAIN                                                                 05/23/2025 18:44:26 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\main.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE main.asm SET(SMALL) DEBUG PRINT(.\Listings\main.lst) OBJECT(.\Objects\m
                      ain.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;----------------------------------------------------------
                       2     ; Project: Ultrasonic Echo Timer Measurement
                       3     ; Clock  : 11.0592 MHz
                       4     ; UART   : 9600 baud
                       5     ; UART output = raw TH0/TL0 count of ECHO pulse width
                       6     ;----------------------------------------------------------
                       7     
0000 50756C73          8     MSG_PULSE: DB "Pulse: ", 0
0004 653A2000                
0008 50726F67          9     MSG_START: DB "Program Starting",0
000C 72616D20                
0010 53746172                
0014 74696E67                
0018 00                      
                      10     
                      11     
  0091                12     US_TRIG_R   EQU  P1.1    ; Right Trigger pin
  0090                13     US_ECHO_R   EQU  P1.0    ; Right Echo pin
  00A0                14     LED_FAR_1   EQU  P2.0
  00A4                15     LED_FAR_2   EQU  P2.4
  00A1                16     LED_MID_1   EQU  P2.1
  00A3                17     LED_MID_2   EQU  P2.3
  00A2                18     LED_CLOSE   EQU  P2.2
                      19     
                      20     
                      21     ;$include (delay.inc)
                +1    22     PUBLIC DELAY_10US
                +1    23     PUBLIC DELAY_500US
                +1    24     
0019            +1    25     DELAY_10US:
0019 00         +1    26         NOP
001A 00         +1    27         NOP
001B 00         +1    28         NOP
001C 00         +1    29         NOP
001D 00         +1    30         NOP
001E 00         +1    31         NOP
001F 00         +1    32         NOP
0020 00         +1    33         NOP
0021 00         +1    34         NOP
0022 00         +1    35         NOP
0023 22         +1    36         RET
                +1    37     
                +1    38     
0024            +1    39     DELAY_500US:
0024 7A05       +1    40         MOV R2, #5
0026 7B28       +1    41         L1: MOV R3, #40
0028 00         +1    42         L2: NOP
0029 DBFD       +1    43         DJNZ R3, L2
002B DAF9       +1    44         DJNZ R2, L1
002D 22         +1    45         RET
                      46     
                      47     ;$include (uart.inc)
                +1    48     PUBLIC UART_INIT
                +1    49     PUBLIC UART_SEND
                +1    50     PUBLIC SEND_DECIMAL
                +1    51     PUBLIC SEND_HEX
                +1    52     PUBLIC NIBBLE_TO_ASCII
A51 MACRO ASSEMBLER  MAIN                                                                 05/23/2025 18:44:26 PAGE     2

                +1    53     PUBLIC SEND_TIMER0_HEX
                +1    54     PUBLIC SEND_STRING
                +1    55     PUBLIC DONE_STRING
                +1    56     
                +1    57     
                +1    58     ;=======================
                +1    59     ; UART Initialization
002E            +1    60     UART_INIT:
002E 758DFD     +1    61         MOV TH1, #0FDH       ; Baud = 9600
0031 758BFD     +1    62         MOV TL1, #0FDH
0034 759850     +1    63         MOV SCON, #50H       ; 8-bit UART, REN enabled
0037 D28E       +1    64         SETB TR1
0039 22         +1    65         RET
                +1    66     
                +1    67     ;=======================
                +1    68     ; UART Send Byte (in A)
003A            +1    69     UART_SEND:
003A F599       +1    70         MOV SBUF, A
003C            +1    71     WAIT_SEND:
003C 3099FD     +1    72         JNB TI, WAIT_SEND
003F C299       +1    73         CLR TI
0041 22         +1    74         RET
                +1    75     
                +1    76     ;=======================
                +1    77     ; SEND_DECIMAL: Converts A to 2-digit ASCII
0042            +1    78     SEND_DECIMAL:
0042 75F00A     +1    79         MOV B, #10
0045 84         +1    80         DIV AB
0046 2430       +1    81         ADD A, #'0'
0048 113A       +1    82         ACALL UART_SEND
004A E5F0       +1    83         MOV A, B
004C 2430       +1    84         ADD A, #'0'
004E 113A       +1    85         ACALL UART_SEND
0050 22         +1    86         RET
                +1    87     
                +1    88     ;=======================
                +1    89     ; SEND_HEX: Send A as 2-digit HEX
0051            +1    90     SEND_HEX:
0051 C4         +1    91         SWAP A                ; High nibble first
0052 540F       +1    92         ANL A, #0Fh
0054 1160       +1    93         ACALL NIBBLE_TO_ASCII
0056 113A       +1    94         ACALL UART_SEND
                +1    95     
0058 ED         +1    96         MOV A, R5             ; Restore original
0059 540F       +1    97         ANL A, #0Fh
005B 1160       +1    98         ACALL NIBBLE_TO_ASCII
005D 113A       +1    99         ACALL UART_SEND
005F 22         +1   100         RET
                +1   101     
                +1   102     ; Convert nibble in A to ASCII
0060            +1   103     NIBBLE_TO_ASCII:
0060 2430       +1   104         ADD A, #'0'
0062 B43A02     +1   105         CJNE A, #'9'+1, OK_ASCII
0065 2407       +1   106         ADD A, #7            ; for A-F
0067            +1   107     OK_ASCII:
0067 22         +1   108         RET
                +1   109     
                +1   110     ;=======================
                +1   111     ; Send 16-bit Timer0 value in HEX
0068            +1   112     SEND_TIMER0_HEX:
0068 E58C       +1   113         MOV A, TH0
006A FD         +1   114         MOV R5, A
006B 1151       +1   115         ACALL SEND_HEX
006D E58A       +1   116         MOV A, TL0
006F FD         +1   117         MOV R5, A
0070 1151       +1   118         ACALL SEND_HEX
A51 MACRO ASSEMBLER  MAIN                                                                 05/23/2025 18:44:26 PAGE     3

0072 22         +1   119         RET
                +1   120     
                +1   121     ;=======================
                +1   122     ; UART Send String in DPTR
0073            +1   123     SEND_STRING:
0073 E4         +1   124         CLR A
0074 93         +1   125         MOVC A, @A+DPTR
0075 6006       +1   126         JZ DONE_STRING
0077 113A       +1   127         ACALL UART_SEND
0079 A3         +1   128         INC DPTR
007A 80F7       +1   129         SJMP SEND_STRING
007C 22         +1   130         RET
                +1   131     
007D            +1   132     DONE_STRING:
007D 22         +1   133         RET
                     134     
                     135     ;$include (ultrasonic_logic.inc)
                +1   136     PUBLIC WAIT_ECHO_HIGH
                +1   137     PUBLIC WAIT_RISE
                +1   138     PUBLIC WAIT_ECHO_LOW
                +1   139     
007E            +1   140     WAIT_ECHO_HIGH:
007E 3090FD     +1   141         JNB   US_ECHO_R, WAIT_ECHO_HIGH
0081 C28D       +1   142         CLR  TF0
0083 C28C       +1   143         CLR  TR0
                +1   144     
                +1   145         ; Start Timer0
0085 D28C       +1   146         SETB TR0
                +1   147     
                +1   148     
0087            +1   149     WAIT_RISE:
0087 2090AB     +1   150         JB   US_ECHO_R, GOT_ECHO
008A D8FB       +1   151         DJNZ  R0, WAIT_RISE
008C D9F9       +1   152         DJNZ  R1, WAIT_RISE
                +1   153     
008E            +1   154     WAIT_ECHO_LOW:
008E 2090FD     +1   155             JB   US_ECHO_R, WAIT_ECHO_LOW
0091 C28D       +1   156             CLR  TF0
0093 C28C       +1   157             CLR  TR0
                +1   158     
                +1   159             ; -----------------------------
                +1   160             ; Print "Pulse: " and Timer0
                +1   161             ; -----------------------------
0095 900000     +1   162             MOV DPTR, #MSG_PULSE
0098 1173       +1   163             ACALL SEND_STRING
009A 1168       +1   164             ACALL SEND_TIMER0_HEX
009C 740D       +1   165             MOV A, #13
009E 113A       +1   166             ACALL UART_SEND
00A0 740A       +1   167             MOV A, #10
00A2 113A       +1   168             ACALL UART_SEND
                     169     
                     170     
0000                 171     ORG 0000h
0000 020003          172     LJMP START 
                     173     
0003                 174     START:
0003 758921          175         MOV TMOD, #21H       ; Timer1 Mode 2 (for UART), Timer0 Mode 1
0006 C28C            176         CLR TR0               ; Ensure Timer0 OFF
                     177         ; Reset Timer0 for next round
0008 758A00          178         MOV TL0, #00h
000B 758C00          179         MOV TH0, #00h
                     180     
000E 112E            181         ACALL UART_INIT       ; Initialize UART
                     182     
0010 C2A0            183         CLR LED_FAR_1
0012 C2A4            184         CLR LED_FAR_2
A51 MACRO ASSEMBLER  MAIN                                                                 05/23/2025 18:44:26 PAGE     4

0014 C2A1            185         CLR LED_MID_1
0016 C2A3            186         CLR LED_MID_2
0018 C2A2            187         CLR LED_CLOSE
001A C291            188         CLR US_TRIG_R
001C C290            189         CLR US_ECHO_R
                     190         
001E D2A2            191         SETB LED_CLOSE
                     192         
                     193         ;send start string
0020 900008          194         MOV DPTR,#MSG_START
0023 1173            195         ACALL SEND_STRING
                     196     
0025                 197     MAIN_TOGGLE:
                     198         ; Send TRIG pulse
0025 D291            199         SETB US_TRIG_R
0027 1119            200         ACALL DELAY_10US
0029 C291            201         CLR  US_TRIG_R
                     202     
002B 117E            203     ACALL WAIT_ECHO_HIGH
002D 1187            204     ACALL WAIT_RISE
                     205     
002F                 206     NO_ECHO:
002F C28C            207         CLR TR0
0031 C2A2            208         CLR LED_CLOSE
0033 80F0            209         SJMP MAIN_TOGGLE
                     210     
0035                 211     GOT_ECHO:
0035 118E            212         ACALL WAIT_ECHO_LOW
                     213         ; Reset Timer0 for next round
0037 758A00          214         MOV TL0, #00h
003A 758C00          215         MOV TH0, #00h
                     216     
003D 80E6            217         SJMP MAIN_TOGGLE
                     218     
                     219     END
A51 MACRO ASSEMBLER  MAIN                                                                 05/23/2025 18:44:26 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

B. . . . . . . . .  D ADDR   00F0H   A   
DELAY_10US . . . .  C ADDR   0019H   A   
DELAY_500US. . . .  C ADDR   0024H   A   
DONE_STRING. . . .  C ADDR   007DH   A   
GOT_ECHO . . . . .  C ADDR   0035H   A   
L1 . . . . . . . .  C ADDR   0026H   A   
L2 . . . . . . . .  C ADDR   0028H   A   
LED_CLOSE. . . . .  B ADDR   00A0H.2 A   
LED_FAR_1. . . . .  B ADDR   00A0H.0 A   
LED_FAR_2. . . . .  B ADDR   00A0H.4 A   
LED_MID_1. . . . .  B ADDR   00A0H.1 A   
LED_MID_2. . . . .  B ADDR   00A0H.3 A   
MAIN_TOGGLE. . . .  C ADDR   0025H   A   
MSG_PULSE. . . . .  C ADDR   0000H   A   
MSG_START. . . . .  C ADDR   0008H   A   
NIBBLE_TO_ASCII. .  C ADDR   0060H   A   
NO_ECHO. . . . . .  C ADDR   002FH   A   
OK_ASCII . . . . .  C ADDR   0067H   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SEND_DECIMAL . . .  C ADDR   0042H   A   
SEND_HEX . . . . .  C ADDR   0051H   A   
SEND_STRING. . . .  C ADDR   0073H   A   
SEND_TIMER0_HEX. .  C ADDR   0068H   A   
START. . . . . . .  C ADDR   0003H   A   
TF0. . . . . . . .  B ADDR   0088H.5 A   
TH0. . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL0. . . . . . . .  D ADDR   008AH   A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . .  B ADDR   0088H.6 A   
UART_INIT. . . . .  C ADDR   002EH   A   
UART_SEND. . . . .  C ADDR   003AH   A   
US_ECHO_R. . . . .  B ADDR   0090H.0 A   
US_TRIG_R. . . . .  B ADDR   0090H.1 A   
WAIT_ECHO_HIGH . .  C ADDR   007EH   A   
WAIT_ECHO_LOW. . .  C ADDR   008EH   A   
WAIT_RISE. . . . .  C ADDR   0087H   A   
WAIT_SEND. . . . .  C ADDR   003CH   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
