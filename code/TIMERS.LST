
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	..\Timers.asm
	Object File:	..\timers.hex
	List File:	..\Timers.lst



 Line  I  Addr  Code            Source

    1:				;----------------------------------------------------------
    2:				; Project: Ultrasonic Echo Timer Measurement
    3:				; Clock  : 11.0592 MHz
    4:				; UART   : 9600 baud
    5:				; UART output = raw TH0/TL0 count of ECHO pulse width
    6:				;----------------------------------------------------------
    7:
    8:		B      0091	US_TRIG_R   EQU  P1.1    ; Right Trigger pin
    9:		B      0090	US_ECHO_R   EQU  P1.0    ; Right Echo pin
   10:		B      00A0	LED0 EQU P2.0; 10cm
   11:		B      00A1	LED1 EQU P2.1; 20cm
   12:		B      00A2	LED2 EQU P2.2; 30cm
   13:		B      00A3	LED3 EQU P2.3; 40cm
   14:		B      00A4	LED4 EQU P2.4; 50cm
   15:		B      00A5	LED5 EQU P2.5; 60cm
   16:		B      00A6	LED6 EQU P2.6; 70cm
   17:		B      00A7	LED7 EQU P2.7; >70cm
   18:		B      0093	LED_OUT EQU P1.3;out of range
   19:
   20:
   21:		N      0000	ORG 0000h
   22:	  0000	02 00 5D	LJMP START
   23:
   24:				;=======================
   25:				; UART Initialization
   26:	  0003			UART_INIT:
   27:	  0003	75 8D FD	    MOV TH1, #0FDH       ; Baud = 9600
   28:	  0006	75 8B FD	    MOV TL1, #0FDH
   29:	  0009	75 98 50	    MOV SCON, #50H       ; 8-bit UART, REN enabled
   30:	  000C	D2 8E		    SETB TR1
   31:	  000E	22		    RET
   32:
   33:				;=======================
   34:				; UART Send Byte (in A)
   35:	  000F			UART_SEND:
   36:	  000F	F5 99		    MOV SBUF, A
   37:	  0011			WAIT_SEND:
   38:	  0011	30 99 FD	    JNB TI, WAIT_SEND
   39:	  0014	C2 99		    CLR TI
   40:	  0016	22		    RET
   41:
   42:				;=======================
   43:				; SEND_DECIMAL: Converts A to 2-digit ASCII

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

   44:	  0017			SEND_DECIMAL:
   45:	  0017	75 F0 0A	    MOV B, #10
   46:	  001A	84		    DIV AB
   47:	  001B	24 30		    ADD A, #'0'
   48:	  001D	11 0F		    ACALL UART_SEND
   49:	  001F	E5 F0		    MOV A, B
   50:	  0021	24 30		    ADD A, #'0'
   51:	  0023	11 0F		    ACALL UART_SEND
   52:	  0025	22		    RET
   53:
   54:				;=======================
   55:				; SEND_HEX: Send A as 2-digit HEX
   56:	  0026			SEND_HEX:
   57:	  0026	C4		    SWAP A                ; High nibble first
   58:	  0027	54 0F		    ANL A, #0Fh
   59:	  0029	11 35		    ACALL NIBBLE_TO_ASCII
   60:	  002B	11 0F		    ACALL UART_SEND
   61:
   62:	  002D	ED		    MOV A, R5             ; Restore original
   63:	  002E	54 0F		    ANL A, #0Fh
   64:	  0030	11 35		    ACALL NIBBLE_TO_ASCII
   65:	  0032	11 0F		    ACALL UART_SEND
   66:	  0034	22		    RET
   67:
   68:				; Convert nibble in A to ASCII
   69:	  0035			NIBBLE_TO_ASCII:
   70:	  0035	24 30		    ADD A, #'0'
   71:	  0037	B4 3A 02	    CJNE A, #'9'+1, OK_ASCII
   72:	  003A	24 07		    ADD A, #7            ; for A-F
   73:	  003C			OK_ASCII:
   74:	  003C	22		    RET
   75:
   76:				;=======================
   77:				; Send 16-bit Timer0 value in HEX
   78:	  003D			SEND_TIMER0_HEX:
   79:	  003D	E5 8C		    MOV A, TH0
   80:	  003F	FD		    MOV R5, A
   81:	  0040	11 26		    ACALL SEND_HEX
   82:	  0042	E5 8A		    MOV A, TL0
   83:	  0044	FD		    MOV R5, A
   84:	  0045	11 26		    ACALL SEND_HEX
   85:	  0047	22		    RET
   86:
   87:				;=======================
   88:				; UART Send String in DPTR
   89:	  0048			SEND_STRING:
   90:	  0048	E4		    CLR A
   91:	  0049	93		    MOVC A, @A+DPTR
   92:	  004A	60 05		    JZ DONE_STRING
   93:	  004C	11 0F		    ACALL UART_SEND
   94:	  004E	A3		    INC DPTR
   95:	  004F	80 F7		    SJMP SEND_STRING
   96:	  0051			DONE_STRING:
   97:	  0051	22		    RET
   98:
   99:				;----------------------------------------------------------

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3



 Line  I  Addr  Code            Source

  100:				; Delay ≈10 µs
  101:	  0052			DELAY_10US:
  102:	  0052	00		    NOP
  103:	  0053	00		    NOP
  104:	  0054	00		    NOP
  105:	  0055	00		    NOP
  106:	  0056	00		    NOP
  107:	  0057	00		    NOP
  108:	  0058	00		    NOP
  109:	  0059	00		    NOP
  110:	  005A	00		    NOP
  111:	  005B	00		    NOP
  112:	  005C	22		    RET
  113:
  114:				;----------------------------------------------------------
  115:				; START
  116:	  005D			START:
  117:	  005D	75 89 21	    MOV TMOD, #21H       ; Timer1 Mode 2 (for UART), Timer0 Mode 1
  118:	  0060	C2 8C		    CLR TR0               ; Ensure Timer0 OFF
  119:				    ; Reset Timer0 for next round
  120:	  0062	75 8A 00	    MOV TL0, #00h
  121:	  0065	75 8C 00	    MOV TH0, #00h
  122:
  123:	  0068	11 03		    ACALL UART_INIT       ; Initialize UART
  124:	  006A	C2 A0		    CLR LED0
  125:	  006C	C2 A1		    CLR LED1
  126:	  006E	C2 A2		    CLR LED2
  127:	  0070	C2 A3		    CLR LED3
  128:	  0072	C2 A4		    CLR LED4
  129:	  0074	C2 A5		    CLR LED5
  130:	  0076	C2 A6		    CLR LED6
  131:	  0078	C2 A7		    CLR LED7
  132:	  007A	C2 91		    CLR US_TRIG_R
  133:	  007C	C2 90		    CLR US_ECHO_R
  134:
  135:				    ;send start string
  136:	  007E	90 01 49	    MOV DPTR,#MSG_START
  137:	  0081	11 48		    ACALL SEND_STRING
  138:
  139:	  0083			MAIN_TOGGLE:
  140:				    ; Send TRIG pulse
  141:	  0083	D2 91		    SETB US_TRIG_R
  142:	  0085	11 52		    ACALL DELAY_10US
  143:	  0087	C2 91		    CLR  US_TRIG_R
  144:
  145:	  0089			WAIT_ECHO_HIGH: ; also this was JB and that was waiting for echo low which doesnt make any sense
  146:	  0089	30 90 FD	    JNB   US_ECHO_R, WAIT_ECHO_HIGH
  147:	  008C	C2 8D		    CLR  TF0
  148:	  008E	C2 8C		    CLR  TR0
  149:
  150:				    ; Start Timer0
  151:	  0090	D2 8C		    SETB TR0
  152:
  153:
  154:	  0092			WAIT_RISE:
  155:	  0092	20 90 0E	    JB   US_ECHO_R, GOT_ECHO

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4



 Line  I  Addr  Code            Source

  156:	  0095	D8 FB		    DJNZ  R0, WAIT_RISE
  157:	  0097	D9 F9		    DJNZ  R1, WAIT_RISE
  158:	  0099	80 02		    SJMP  NO_ECHO
  159:
  160:	  009B	C2 93		CLR LED_OUT
  161:
  162:	  009D			NO_ECHO:
  163:	  009D	C2 8C		    CLR TR0
  164:	  009F	D2 93		    SETB LED_OUT
  165:	  00A1	80 E0		    SJMP MAIN_TOGGLE
  166:
  167:	  00A3			GOT_ECHO:
  168:				;i can belive this fixed everything
  169:	  00A3			WAIT_ECHO_LOW:
  170:	  00A3	20 90 FD	    JB   US_ECHO_R, WAIT_ECHO_LOW
  171:	  00A6	C2 8D		    CLR  TF0
  172:	  00A8	C2 8C		    CLR  TR0
  173:
  174:				    ; -----------------------------
  175:				    ; Print "Pulse: " and Timer0
  176:				    ; -----------------------------
  177:	  00AA	90 01 41	    MOV DPTR, #MSG_PULSE
  178:	  00AD	11 48		    ACALL SEND_STRING
  179:	  00AF	E5 8C		    MOV A,TH0
  180:	  00B1	11 17		    ACALL SEND_DECIMAL
  181:	  00B3	E5 8A		    MOV A,TL0
  182:	  00B5	11 17		    ACALL SEND_DECIMAL
  183:	  00B7	74 0D		    MOV A, #13
  184:	  00B9	11 0F		    ACALL UART_SEND
  185:	  00BB	74 0A		    MOV A, #10
  186:	  00BD	11 0F		    ACALL UART_SEND
  187:
  188:				        ; Calculate pulse duration
  189:	  00BF	E5 8A		    MOV A, TL0       ; Store TL0 in R0
  190:	  00C1	F8		    MOV R0, A
  191:	  00C2	E5 8C		    MOV A, TH0       ; Store TH0 in R1
  192:	  00C4	F9		    MOV R1, A
  193:
  194:				    ; Use DPH:DPL = R1:R0 to load 16-bit value
  195:	  00C5	88 82		    MOV DPL, R0
  196:	  00C7	89 83		    MOV DPH, R1
  197:
  198:				    ; Approximate Distance = timer / 53
  199:				    ; Result will be in R2
  200:	  00C9	7A 00		    MOV R2, #0        ; Distance result = 0
  201:
  202:	  00CB			DIV_LOOP:
  203:	  00CB	C3		    CLR C
  204:	  00CC	E5 82		    MOV A, DPL
  205:	  00CE	94 35		    SUBB A, #53
  206:	  00D0	F5 82		    MOV DPL, A
  207:	  00D2	E5 83		    MOV A, DPH
  208:	  00D4	94 00		    SUBB A, #00
  209:	  00D6	F5 83		    MOV DPH, A
  210:	  00D8	40 03		    JC DIV_DONE       ; Stop if DPH:DPL < 53
  211:	  00DA	0A		    INC R2

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



 Line  I  Addr  Code            Source

  212:	  00DB	80 EE		    SJMP DIV_LOOP
  213:
  214:	  00DD			DIV_DONE:
  215:				    ; Display Distance (in cm)
  216:	  00DD	90 01 5A	    MOV DPTR, #MSG_DISTANCE
  217:	  00E0	11 48		    ACALL SEND_STRING
  218:	  00E2	EA		    MOV A, R2
  219:	  00E3	11 17		    ACALL SEND_DECIMAL
  220:	  00E5	74 0D		    MOV A, #13
  221:	  00E7	11 0F		    ACALL UART_SEND
  222:	  00E9	74 0A		    MOV A, #10
  223:	  00EB	11 0F		    ACALL UART_SEND
  224:
  225:				        ; ----- Clear all LEDs (P2.0 to P2.7) -----
  226:	  00ED	C2 A0		    CLR LED0
  227:	  00EF	C2 A1		    CLR LED1
  228:	  00F1	C2 A2		    CLR LED2
  229:	  00F3	C2 A3		    CLR LED3
  230:	  00F5	C2 A4		    CLR LED4
  231:	  00F7	C2 A5		    CLR LED5
  232:	  00F9	C2 A6		    CLR LED6
  233:	  00FB	C2 A7		    CLR LED7
  234:
  235:				    ; ----- Light LEDs based on distance in R2 -----
  236:	  00FD	EA		    MOV A, R2
  237:
  238:	  00FE	B4 0A 02	    CJNE A, #10, CHECK_20
  239:	  0101	D2 A0		    SETB LED0
  240:
  241:	  0103			CHECK_20:
  242:	  0103	40 33		    JC DONE_LEDS       ; A < 10
  243:	  0105	D2 A0		    SETB LED0
  244:	  0107	B4 14 02	    CJNE A, #20, CHECK_30
  245:	  010A	D2 A1		    SETB LED1
  246:
  247:	  010C			CHECK_30:
  248:	  010C	40 2A		    JC DONE_LEDS
  249:	  010E	D2 A1		    SETB LED1
  250:	  0110	B4 1E 02	    CJNE A, #30, CHECK_40
  251:	  0113	D2 A2		    SETB LED2
  252:
  253:	  0115			CHECK_40:
  254:	  0115	40 21		    JC DONE_LEDS
  255:	  0117	D2 A2		    SETB LED2
  256:	  0119	B4 28 02	    CJNE A, #40, CHECK_50
  257:	  011C	D2 A3		    SETB LED3
  258:
  259:	  011E			CHECK_50:
  260:	  011E	40 18		    JC DONE_LEDS
  261:	  0120	D2 A3		    SETB LED3
  262:	  0122	B4 32 02	    CJNE A, #50, CHECK_60
  263:	  0125	D2 A4		    SETB LED4
  264:
  265:	  0127			CHECK_60:
  266:	  0127	40 0F		    JC DONE_LEDS
  267:	  0129	D2 A4		    SETB LED4

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 6



 Line  I  Addr  Code            Source

  268:	  012B	B4 3C 02	    CJNE A, #60, CHECK_70
  269:	  012E	D2 A5		    SETB LED5
  270:
  271:	  0130			CHECK_70:
  272:	  0130	40 06		    JC DONE_LEDS
  273:	  0132	D2 A5		    SETB LED5
  274:	  0134	D2 A6		    SETB LED6
  275:	  0136	D2 A7		    SETB LED7           ; Everything beyond 70 cm → all LEDs ON
  276:
  277:	  0138			DONE_LEDS:
  278:
  279:				    ; Reset Timer0 for next round
  280:	  0138	75 8A 00	    MOV TL0, #00h
  281:	  013B	75 8C 00	    MOV TH0, #00h
  282:
  283:
  284:	  013E	02 00 83	    LJMP MAIN_TOGGLE
  285:
  286:				;---------------------Rom Message------------------------------------
  287:	  0141	50 75 6C 73	MSG_PULSE: DB "Pulse: ", 0
	  0145	65 3A 20 00
  288:	  0149	50 72 6F 67	MSG_START: DB "Program Starting",0
	  014D	72 61 6D 20
	  0151	53 74 61 72
	  0155	74 69 6E 67
	  0159	00
  289:	  015A	44 69 73 74	MSG_DISTANCE: DB "Distance: ", 0
	  015E	61 6E 63 65
	  0162	3A 20 00
  290:
  291:
  292:				END





                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 7





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6
ACC				  DATA	      E0
B				  DATA	      F0
CHECK_20			  CODE	    0103	 241
CHECK_30			  CODE	    010C	 247
CHECK_40			  CODE	    0115	 253
CHECK_50			  CODE	    011E	 259
CHECK_60			  CODE	    0127	 265
CHECK_70			  CODE	    0130	 271
CY				  BIT	      D7
DELAY_10US			  CODE	    0052	 101
DIV_DONE			  CODE	    00DD	 214
DIV_LOOP			  CODE	    00CB	 202
DONE_LEDS			  CODE	    0138	 277
DONE_STRING			  CODE	    0051	  96
DPH				  DATA	      83
DPL				  DATA	      82
EA				  BIT	      AF
ES				  BIT	      AC
ET0				  BIT	      A9
ET1				  BIT	      AB
EX0				  BIT	      A8
EX1				  BIT	      AA
EXTI0				  CODE	    0003
EXTI1				  CODE	    0013
F0				  BIT	      D5
GOT_ECHO			  CODE	    00A3	 167
IE				  DATA	      A8
IE0				  BIT	      89
IE1				  BIT	      8B
INT0				  BIT	      B2
INT1				  BIT	      B3
IP				  DATA	      B8
IT0				  BIT	      88
IT1				  BIT	      8A
LED0				  NUMBER    00A0	  10
LED1				  NUMBER    00A1	  11
LED2				  NUMBER    00A2	  12
LED3				  NUMBER    00A3	  13
LED4				  NUMBER    00A4	  14
LED5				  NUMBER    00A5	  15
LED6				  NUMBER    00A6	  16
LED7				  NUMBER    00A7	  17
LED_OUT				  NUMBER    0093	  18
MAIN_TOGGLE			  CODE	    0083	 139
MSG_DISTANCE			  CODE	    015A	 289
MSG_PULSE			  CODE	    0141	 287
MSG_START			  CODE	    0149	 288

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 8



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
NIBBLE_TO_ASCII			  CODE	    0035	  69
NO_ECHO				  CODE	    009D	 162
OK_ASCII			  CODE	    003C	  73
OV				  BIT	      D2
P				  BIT	      D0
P0				  DATA	      80
P1				  DATA	      90
P2				  DATA	      A0
P3				  DATA	      B0
PCON				  DATA	      87
PS				  BIT	      BC
PSW				  DATA	      D0
PT0				  BIT	      B9
PT1				  BIT	      BB
PX0				  BIT	      B8
PX1				  BIT	      BA
RB8				  BIT	      9A
RD				  BIT	      B7
REN				  BIT	      9C
RESET				  CODE	    0000
RI				  BIT	      98
RS0				  BIT	      D3
RS1				  BIT	      D4
RXD				  BIT	      B0
SBUF				  DATA	      99
SCON				  DATA	      98
SEND_DECIMAL			  CODE	    0017	  44
SEND_HEX			  CODE	    0026	  56
SEND_STRING			  CODE	    0048	  89
SEND_TIMER0_HEX			  CODE	    003D	  78
SINT				  CODE	    0023
SM0				  BIT	      9F
SM1				  BIT	      9E
SM2				  BIT	      9D
SP				  DATA	      81
START				  CODE	    005D	 116
T0				  BIT	      B4
T1				  BIT	      B5
TB8				  BIT	      9B
TCON				  DATA	      88
TF0				  BIT	      8D
TF1				  BIT	      8F
TH0				  DATA	      8C
TH1				  DATA	      8D
TI				  BIT	      99
TIMER0				  CODE	    000B
TIMER1				  CODE	    001B
TL0				  DATA	      8A
TL1				  DATA	      8B
TMOD				  DATA	      89
TR0				  BIT	      8C
TR1				  BIT	      8E
TXD				  BIT	      B1
UART_INIT			  CODE	    0003	  26
UART_SEND			  CODE	    000F	  35
US_ECHO_R			  NUMBER    0090	   9

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 9



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
US_TRIG_R			  NUMBER    0091	   8
WAIT_ECHO_HIGH			  CODE	    0089	 145
WAIT_ECHO_LOW			  CODE	    00A3	 169
WAIT_RISE			  CODE	    0092	 154
WAIT_SEND			  CODE	    0011	  37
WR				  BIT	      B6
